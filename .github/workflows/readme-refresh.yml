# .github/workflows/live-stats-update.yml
name: Live Stats Update

on:
  schedule:
    - cron: "0 */2 * * *"   # Every 2 hours
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    types: [ opened, synchronize, closed ]

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get GitHub Stats
        id: get-stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER_LOGIN: ${{ github.repository_owner }}
        run: |
          echo "Fetching stats for $USER_LOGIN..."
          
          # Get current year
          YEAR=$(date +%Y)
          
          # Get total contributions using GitHub REST API
          echo "Getting contribution data..."
          
          # Get user data
          USER_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USER_LOGIN")
          
          # Get repositories
          REPOS_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USER_LOGIN/repos?per_page=100&type=all")
          
          # Get followers
          FOLLOWERS_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$USER_LOGIN/followers?per_page=100")
          
          # Extract basic stats
          TOTAL_REPOS=$(echo "$REPOS_DATA" | jq 'length // 0')
          TOTAL_FOLLOWERS=$(echo "$FOLLOWERS_DATA" | jq 'length // 0')
          
          # Calculate total stars
          TOTAL_STARS=$(echo "$REPOS_DATA" | jq 'map(.stargazers_count) | add // 0')
          
          echo "Basic stats extracted:"
          echo "Total Repos: $TOTAL_REPOS"
          echo "Total Followers: $TOTAL_FOLLOWERS"
          echo "Total Stars: $TOTAL_STARS"
          
          # Set outputs
          echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
          echo "total_followers=$TOTAL_FOLLOWERS" >> $GITHUB_OUTPUT
          echo "total_stars=$TOTAL_STARS" >> $GITHUB_OUTPUT
          echo "current_year=$YEAR" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          echo "Updating README with new stats..."
          
          # Get values from previous step
          TOTAL_REPOS="${{ steps.get-stats.outputs.total_repos }}"
          TOTAL_FOLLOWERS="${{ steps.get-stats.outputs.total_followers }}"
          TOTAL_STARS="${{ steps.get-stats.outputs.total_stars }}"
          CURRENT_YEAR="${{ steps.get-stats.outputs.current_year }}"
          
          # Update refresh marker
          TODAY=$(date +%Y-%m-%d)
          if grep -q "<!--last_refresh-->" README.md; then
            sed -i "s|<!--last_refresh:.*-->|<!--last_refresh:$TODAY-->|" README.md
            echo "Updated refresh marker to $TODAY"
          else
            sed -i "1s|^|<!--last_refresh:$TODAY-->\n|" README.md
            echo "Added refresh marker: $TODAY"
          fi
          
          # Update year if marker exists
          if grep -q "<!--current_year-->" README.md; then
            sed -i "s|<!--current_year-->[0-9]*<!--/current_year-->|<!--current_year-->$CURRENT_YEAR<!--/current_year-->|" README.md
            echo "Updated year to $CURRENT_YEAR"
          fi
          
          echo "README updated successfully"

      - name: Create Stats Summary
        run: |
          cat > stats_summary.md <<EOF
          # GitHub Stats Summary for ${{ github.repository_owner }}
          
          **Last Updated**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“Š Current Stats
          - **Total Repositories**: ${{ steps.get-stats.outputs.total_repos }}
          - **Total Followers**: ${{ steps.get-stats.outputs.total_followers }}
          - **Total Stars Earned**: ${{ steps.get-stats.outputs.total_stars }}
          - **Current Year**: ${{ steps.get-stats.outputs.current_year }}
          
          ## ï¿½ï¿½ Live Stats Badges
          ![Repositories](https://img.shields.io/badge/Repositories-${{ steps.get-stats.outputs.total_repos }}-FF6BD6?style=for-the-badge&logo=github&logoColor=white)
          ![Followers](https://img.shields.io/badge/Followers-${{ steps.get-stats.outputs.total_followers }}-8B5CF6?style=for-the-badge&logo=github&logoColor=white)
          ![Stars](https://img.shields.io/badge/Stars-${{ steps.get-stats.outputs.total_stars }}-F59E0B?style=for-the-badge&logo=github&logoColor=white)
          EOF
          
          echo "Stats summary created"

      - name: Commit and Push
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md stats_summary.md
            git commit -m "chore: update live GitHub stats [skip ci]"
            git push
            echo "Changes committed and pushed successfully"
          else
            echo "No changes to commit"
          fi

      - name: Show Summary
        run: |
          echo "## Workflow completed successfully!"
          if [[ -f "stats_summary.md" ]]; then
            echo "Stats summary:"
            cat stats_summary.md
          fi
